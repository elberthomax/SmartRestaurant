<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>Comelo - Smart Restaurant</title>

        <!-- Bootstrap -->
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="css/customer-style.css">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>

        <div class="wrapper">

            <div class="container-fluid">
                <div class="row">

                    <div class="col-9" id="left">
                        <div id="kategoriContainer" class="row food-beverage h-auto">
                        </div>

                        <div id="menuList" class="row menu-list">
                        </div>
                    </div>

                    <div class="col-3" id="right">

                        <div class="row h-auto">
                            <div class="comelo text-center">
                                <h1 class="comelo">
                                    comelo
                                </h1>
                            </div>
                        </div>

                        <div class="row order-list text-center">
                            <div style="display: hidden; width: 100%" id="currentOrder" class="order-btn text-center"></div>
                            <div id="orderList" class="order-btn text-center" style="width: 100%;">
                                <button onclick="processOrder()" id="button" class="order-btn btn" style="padding-left: 12px; padding-right: 12px" disabled>
                                    <p style="padding-left: 12px; padding-right: 12px">ORDER</p>
                                </button></div>
                        </div>
                    </div>

                </div>
            </div>

        </div>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="js/bootstrap.min.js"></script>
        <script type="text/javascript">
            let url = {
                "getMenu" : "http://stevelukis.com/smart-restaurant/backend/customer/menu",
                "getCategory" : "http://stevelukis.com/smart-restaurant/backend/manager/get_categories",
                "getOrderStatus" : "http://stevelukis.com/smart-restaurant/backend/customer/order_status",
                "order" : "http://stevelukis.com/smart-restaurant/backend/customer/order"
            }
            let user_id = "";
            let list = {};
            function sendPost(url, data, callback){
                let xhr = new XMLHttpRequest();
                xhr.open("POST", url, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        callback(JSON.parse(xhr.responseText));
                    }
                };
                xhr.send(JSON.stringify(data));
            }

            function initialize(){
                user_id = window.localStorage.getItem("user_id");
                if(user_id !== null){
                    sendPost(url["getMenu"], {}, function(response){
                        list = response;
                        sendPost(url["getCategory"], {}, function(response){
                            let text = '';
                            response.forEach(function (item){
                                text += `
                                <div class="col-3 text-center">
                                <a id="${item["name"]}" onclick="select('${item['name']}')">
                                <h3>${item['name']}</h3>
                                </a>
                                </div>`;
                            });
                            document.getElementById("kategoriContainer").innerHTML = text;
                            select(response[0]["name"]);
                        });
                    });
                }else{
                    alert("silahkan registrasi meja terlebih dahulu");
                    window.location.href = "register.html";
                }
            }

            function select(categoryName){
                let selected = document.getElementsByClassName("selected");
                if(selected.length !== 0){
                    selected[0].setAttribute("class","");
                }
                selected = document.getElementById(categoryName);
                selected.setAttribute("class","selected");
                let text = '';
                list.forEach(function(item, index){
                    if(item["category"] == categoryName){
                        text +=`
                        <div class="col-6">
                            <div class="card">
                                <img class="card-img-top h-75" src="${item["image_url"]}" alt="${item["name"]}">
                                <div class="container h-25">
                                    <div class="row">
                                        <div class="col-2 text-center">
                                            <div class="row">
                                                <button onclick="minus(${index})" class="min-btn btn">
                                                    <h1>-</h1>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="col-8 text-center">
                                            <div class="row">
                                                <div class="card-body">
                                                    <p class="menu-desc">Rp. ${item["price"]}</p>
                                                    <h3 class="menu-desc">${item["name"]}</h3>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-2 text-center">
                                            <div class="row">
                                                <button onclick="plus(${index})" class="plus-btn btn">
                                                    <h1>+</h1>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }
                });
                document.getElementById("menuList").innerHTML = text;
            }

            function plus(index){
                if(list[index]["banyak"] == undefined){
                    list[index]["banyak"] = 1;
                }else {
                    list[index]["banyak"] += 1;
                }
                loadOrderList();
            }
            function minus(index){
                if(list[index]["banyak"] > 0){
                    list[index]["banyak"] -= 1;
                }
                loadOrderList();
            }
            function loadOrderList(){
                let status = true;
                let text = `
                <button onclick="processOrder()" id="button" class="order-btn btn" style="padding-left: 12px; padding-right: 12px">
                    <p style="padding-left: 12px; padding-right: 12px">ORDER</p>
                </button>`;
                list.forEach(function(item){
                    if(item["banyak"] > 0){
                        status = false;
                        text += `<h3 style = "text-align:left; width:100%"> ${item["name"]} <span style = "float:right"> ${item["banyak"]} </span></h3>`;
                    }
                });
                document.getElementById("orderList").innerHTML = text;
                document.getElementById("button").disabled = status;
            }
            function processOrder(){
                let text = "";
                list.forEach(function(item, index){
                    if(item["banyak"] > 0){
                        let data = { "user_id": user_id,
                        "menu_id": item["id"],
                        "quantity": item["banyak"] }
                        sendPost(url["order"], data, function(response){});
                        text += `${item["name"]}: ${item["banyak"]}\n`;
                        item["banyak"] = 0;
                    }
                });
                testMenu(text);
            }
            function testMenu(text){
                let success = true;
                list.forEach(function(item){
                    if(item["banyak"] > 0){
                        success = false;
                    }
                });
                if(success){
                    text += "memesan sukses";
                }else{
                    text += "pesanan tak selesai sempurna";
                }
                alert(text);
                loadOrderList();
                orderProcessed();
            }
            function generateCurrentOrder(){
                sendPost(url["getOrderStatus"], {"user_id": user_id}, function(response){
                    let text = "<h3>Pesanan Saat Ini</h3>\n";
                    response.forEach(function(item){
                        text += `<h3 style = "text-align:left; width:100%"> ${item["menu"]} <span style = "float:right"> ${item["quantity"]} </span></h3>
                        <h3 style = "text-align:left; width:100%"> status : ${item["cooked_status"]}</h3>`;
                    });
                    document.getElementById("currentOrder").innerHTML = text;
                });
            }
            function orderProcessed(){
                generateCurrentOrder();
                document.getElementById("currentOrder").style.display = "inline";
                window.setInterval(function(){
                    generateCurrentOrder();
                }, 5000);
            }
            initialize();
        </script>
    </body>
</html>
